name: Nightly Lint & Typecheck

on:
  schedule:
    # Run at 1:30 AM UTC daily (adjust if you like)
    - cron: "30 1 * * *"
  workflow_dispatch: {} # allow manual trigger from the Actions tab

permissions:
  contents: write # Required for auto-commit and push

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Prevent hanging

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Run lint to detect errors and warnings (continue on error to allow fixing)
      - name: Run ESLint (detect errors)
        id: lint
        run: |
          if npm run lint:fast; then
            echo "lint_errors=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Lint passed with no errors or warnings"
          else
            echo "lint_errors=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Lint found errors or warnings"
          fi
        continue-on-error: true

      # Run typecheck to detect errors (continue on error to allow fixing)
      - name: Run TypeScript typecheck (detect errors)
        id: typecheck
        run: |
          if npm run typecheck; then
            echo "typecheck_errors=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Typecheck passed with no errors"
          else
            echo "typecheck_errors=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Typecheck found errors"
          fi
        continue-on-error: true

      # Check if any errors were detected
      - name: Check for errors
        id: errors
        run: |
          echo "DEBUG: lint_errors = ${{ steps.lint.outputs.lint_errors }}"
          echo "DEBUG: typecheck_errors = ${{ steps.typecheck.outputs.typecheck_errors }}"
          if [ "${{ steps.lint.outputs.lint_errors }}" == "true" ] || [ "${{ steps.typecheck.outputs.typecheck_errors }}" == "true" ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Errors detected - will run auto-fixes and Cursor agent"
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No errors detected - skipping auto-fixes"
          fi

      # Run mechanical auto-fixes (safe, low-risk)
      - name: Run Prettier formatting
        if: steps.errors.outputs.has_errors == 'true'
        run: |
          echo "üé® Running Prettier formatting..."
          npm run format || echo "prettier_failed=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: Run ESLint auto-fix (removes unused imports + other fixes)
        if: steps.errors.outputs.has_errors == 'true'
        run: |
          echo "üîß Running ESLint auto-fix (removes unused imports)..."
          npm run lint -- --fix || echo "eslint_fix_failed=true" >> $GITHUB_ENV
        continue-on-error: true

      # Install Cursor CLI if errors were detected (with caching)
      - name: Install Cursor CLI
        if: steps.errors.outputs.has_errors == 'true'
        run: |
          if [ -f "$HOME/.local/bin/cursor-agent" ]; then
            echo "‚úÖ Cursor CLI found in cache"
          else
            echo "üì• Installing Cursor CLI..."
            curl https://cursor.com/install -fsS | bash || echo "cursor_install_failed=true" >> $GITHUB_ENV
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      # Run Cursor agent to fix errors
      - name: Run Cursor Agent to fix lint and TS errors
        if: steps.errors.outputs.has_errors == 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          echo "üîç Starting Cursor agent..."
          echo "DEBUG: has_errors = ${{ steps.errors.outputs.has_errors }}"
          if [ -z "$CURSOR_API_KEY" ]; then
            echo "‚ö†Ô∏è CURSOR_API_KEY not set. Skipping Cursor agent."
            exit 0
          fi
          echo "‚úÖ CURSOR_API_KEY is set"
          echo "üöÄ Running cursor-agent with auto model selection..."
          cursor-agent -p "Fix the following ESLint warnings that were detected: no-case-declarations, no-constant-binary-expression, prefer-const, no-unexpected-multiline, and remove unused eslint-disable directives. Only fix these specific lint warnings, don't change functionality or fix other issues." --model auto || echo "cursor_agent_failed=true" >> $GITHUB_ENV
          echo "‚úÖ Cursor agent completed"
        continue-on-error: true

      # Clean up temporary files before checking changes
      - name: Clean up temporary files
        if: steps.errors.outputs.has_errors == 'true'
        run: |
          # Remove files that shouldn't be committed
          rm -f .eslintcache check-errors.mjs
          git clean -fd || true

      # Check if there are changes to commit
      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected - will commit and push"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected - nothing to commit"
          fi

      # Configure git to skip hooks for auto-commits
      - name: Configure git to skip hooks
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config core.hooksPath /dev/null

      # Auto-commit and push changes
      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'chore: fix lint and TypeScript errors [auto-fix] [skip ci]'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
          skip_dirty_check: true
