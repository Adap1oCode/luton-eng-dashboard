name: Nightly Verification

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  nightly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium
      
      - name: Run nightly verification
        id: nightly
        run: npm run ci:nightly
        continue-on-error: true
      
      - name: Check for failures
        if: steps.nightly.outcome == 'failure'
        run: |
          echo "âŒ Nightly verification failed"
          echo "Creating issue would happen here (requires GitHub token)"
          # TODO: Create GitHub issue with failure details
          # gh issue create --title "Nightly Verification Failed $(date +%Y-%m-%d)" --body "Nightly verification failed. See workflow run for details."
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results
          path: |
            coverage/
            test-results/
            playwright-report/
      
      - name: Check for auto-fix changes
        if: steps.nightly.outcome == 'success'
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Auto-fixes were applied"
            git diff --stat
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create PR for auto-fixes
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: apply nightly auto-fixes'
          title: 'chore: apply nightly auto-fixes'
          body: |
            This PR contains auto-fixes from the nightly verification run.
            
            Changes:
            - Lint auto-fixes
            - Code formatting
            
            Please review and merge if changes look good.
          branch: chore/nightly-auto-fixes
          delete-branch: true

