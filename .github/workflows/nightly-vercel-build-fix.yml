name: Nightly Vercel Build Fix

on:
  schedule:
    # Run at 2:00 AM UTC daily (after lint workflow at 1:30 AM)
    - cron: "0 2 * * *"
  workflow_dispatch: {} # allow manual trigger from the Actions tab

permissions:
  contents: write # Required for creating branches, PRs, and commits
  pull-requests: write # Required for creating PRs

jobs:
  check-and-fix-vercel-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20 # Allow more time for build analysis

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for branch creation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Check latest Vercel deployment status using REST API
      - name: Check Vercel build status
        id: vercel_check
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "‚ö†Ô∏è VERCEL_TOKEN not set. Skipping Vercel build check."
            echo "build_status=SKIP" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üîç Checking latest Vercel deployment via API..."
          
          # Use Vercel REST API to get latest deployment
          # API: https://vercel.com/docs/rest-api#endpoints/deployments
          # Project ID defaults to repository name (e.g., "owner/repo" -> "repo")
          # Override with VERCEL_PROJECT_ID secret if your Vercel project name differs
          DEFAULT_PROJECT_ID="${GITHUB_REPOSITORY##*/}"  # Extract repo name from "owner/repo"
          PROJECT_ID="${VERCEL_PROJECT_ID:-$DEFAULT_PROJECT_ID}"
          TEAM_PARAM=""
          if [ -n "$VERCEL_TEAM_ID" ]; then
            TEAM_PARAM="?teamId=$VERCEL_TEAM_ID"
          fi
          
          echo "üì¶ Using project ID: $PROJECT_ID"
          
          # Get latest deployment
          RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments$TEAM_PARAM&projectId=$PROJECT_ID&limit=1" || echo "{}")
          
          if [ "$RESPONSE" = "{}" ] || [ -z "$RESPONSE" ]; then
            echo "‚ö†Ô∏è Failed to fetch deployments or no deployments found"
            echo "build_status=UNKNOWN" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract deployment info using jq
          DEPLOYMENT=$(echo "$RESPONSE" | jq -r '.deployments[0] // empty')
          
          if [ -z "$DEPLOYMENT" ] || [ "$DEPLOYMENT" = "null" ]; then
            echo "‚ö†Ô∏è No deployments found"
            echo "build_status=UNKNOWN" >> $GITHUB_OUTPUT
            exit 0
          fi

          STATE=$(echo "$DEPLOYMENT" | jq -r '.readyState // .state // "UNKNOWN"')
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT" | jq -r '.uid // ""')
          URL=$(echo "$DEPLOYMENT" | jq -r '.url // ""')

          echo "üìä Latest deployment: $DEPLOYMENT_ID"
          echo "üåê URL: $URL"
          echo "üìà State: $STATE"

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "deployment_url=$URL" >> $GITHUB_OUTPUT
          echo "build_status=$STATE" >> $GITHUB_OUTPUT

          if [ "$STATE" = "ERROR" ] || [ "$STATE" = "BUILD_ERROR" ] || [ "$STATE" = "CANCELED" ]; then
            echo "‚ùå Build failed - will attempt to fix"
            echo "needs_fix=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Build is healthy (state: $STATE)"
            echo "needs_fix=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Get build logs if build failed
      - name: Get build logs
        id: build_logs
        if: steps.vercel_check.outputs.needs_fix == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          DEPLOYMENT_ID="${{ steps.vercel_check.outputs.deployment_id }}"
          echo "üìã Fetching build logs for deployment $DEPLOYMENT_ID..."
          
          TEAM_PARAM=""
          if [ -n "$VERCEL_TEAM_ID" ]; then
            TEAM_PARAM="?teamId=$VERCEL_TEAM_ID"
          fi
          
          # Get build logs using Vercel REST API
          LOGS_RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v2/deployments/$DEPLOYMENT_ID/events$TEAM_PARAM" || echo "[]")
          
          # Extract log events and format them
          LOGS=$(echo "$LOGS_RESPONSE" | jq -r '.[] | "\(.createdAt // "") [\(.type // "")] \(.payload // "")"' 2>/dev/null || echo "Failed to parse logs")
          
          # Save logs to file for Cursor agent
          echo "$LOGS" > vercel-build-logs.txt
          
          # Extract error summary (lines with "error" or "Error" or "failed")
          ERROR_SUMMARY=$(echo "$LOGS" | grep -i "error\|failed\|‚úñ\|‚ùå" | tail -50 || echo "No specific errors found in logs")
          
          echo "üìù Error summary saved to vercel-build-logs.txt"
          echo "error_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$ERROR_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      # Create branch for fixes
      - name: Create fix branch
        id: branch
        if: steps.vercel_check.outputs.needs_fix == 'true'
        run: |
          BRANCH_NAME="fix/vercel-build-$(date +%Y%m%d-%H%M%S)"
          echo "üåø Creating branch: $BRANCH_NAME"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Branch created: $BRANCH_NAME"

      # Install Cursor CLI
      - name: Install Cursor CLI
        if: steps.vercel_check.outputs.needs_fix == 'true'
        run: |
          if [ -f "$HOME/.local/bin/cursor-agent" ]; then
            echo "‚úÖ Cursor CLI found in cache"
          else
            echo "üì• Installing Cursor CLI..."
            curl https://cursor.com/install -fsS | bash || echo "cursor_install_failed=true" >> $GITHUB_ENV
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      # Run Cursor agent to fix build issues
      - name: Run Cursor Agent to fix build errors
        if: steps.vercel_check.outputs.needs_fix == 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [ -z "$CURSOR_API_KEY" ]; then
            echo "‚ö†Ô∏è CURSOR_API_KEY not set. Skipping Cursor agent."
            exit 0
          fi

          echo "üîç Starting Cursor agent to fix Vercel build errors..."
          
          # Read build logs
          if [ -f vercel-build-logs.txt ]; then
            LOGS_CONTENT=$(cat vercel-build-logs.txt | head -2000) # Limit to avoid token limits
          else
            LOGS_CONTENT="Build logs not available"
          fi

          PROMPT="A Vercel build failed with the following errors. Analyze the build logs and fix the issues. Focus on:
1. TypeScript compilation errors (syntax, types, missing imports)
2. ESLint errors (code quality issues)
3. Build configuration issues (next.config, tsconfig)
4. Missing dependencies or import errors

DO NOT fix:
- Environment variable issues (these require manual configuration)
- Runtime logic errors (these need human review)
- Infrastructure issues

Build logs:
\`\`\`
$LOGS_CONTENT
\`\`\`

Deployment URL: ${{ steps.vercel_check.outputs.deployment_url }}
Deployment ID: ${{ steps.vercel_check.outputs.deployment_id }}

Fix only the safe, mechanical issues. If the errors are complex or require context, make minimal safe changes and add TODO comments."

          echo "üöÄ Running cursor-agent..."
          cursor-agent -p "$PROMPT" --model auto || echo "cursor_agent_failed=true" >> $GITHUB_ENV
          echo "‚úÖ Cursor agent completed"
        continue-on-error: true

      # Check if there are changes to commit
      - name: Check for changes
        id: changes
        if: steps.vercel_check.outputs.needs_fix == 'true'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected - will commit and create PR"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected - nothing to commit"
          fi

      # Commit changes
      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config core.hooksPath /dev/null
          git add -A
          git commit -m "fix: auto-fix Vercel build errors [auto-fix]

          Deployment: ${{ steps.vercel_check.outputs.deployment_url }}
          Deployment ID: ${{ steps.vercel_check.outputs.deployment_id }}
          
          Auto-generated by nightly-vercel-build-fix workflow.
          Please review before merging." || echo "commit_failed=true" >> $GITHUB_ENV
        continue-on-error: true

      # Push branch
      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin "${{ steps.branch.outputs.branch_name }}" || echo "push_failed=true" >> $GITHUB_ENV
        continue-on-error: true

      # Create PR
      - name: Create Pull Request
        id: pr
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.branch.outputs.branch_name }}';
            const deploymentUrl = '${{ steps.vercel_check.outputs.deployment_url }}';
            const deploymentId = '${{ steps.vercel_check.outputs.deployment_id }}';
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîß Auto-fix: Vercel build errors [${new Date().toISOString().split('T')[0]}]`,
              head: branchName,
              base: 'main',
              body: `## üîß Auto-Fix: Vercel Build Errors

              **Deployment:** ${deploymentUrl}
              **Deployment ID:** ${deploymentId}
              
              This PR was automatically created to fix Vercel build errors detected in the nightly check.
              
              ### What was fixed:
              - TypeScript compilation errors
              - ESLint errors
              - Build configuration issues
              - Missing imports/dependencies
              
              ### Review Checklist:
              - [ ] Review changes for safety
              - [ ] Verify build passes on Vercel preview
              - [ ] Check that no functionality was broken
              - [ ] Merge if changes look safe
              
              **Auto-generated by:** \`nightly-vercel-build-fix\` workflow
              
              ---
              *This PR will be reviewed by an AI agent in the next step.*`,
              draft: false
            });
            
            console.log(`‚úÖ PR created: ${pr.data.html_url}`);
            return pr.data.number;
        continue-on-error: true

      # Agent 2: AI Review of PR (using Cursor agent)
      - name: Agent 2 - AI Review PR Changes
        id: ai_review
        if: steps.changes.outputs.has_changes == 'true' && steps.pr.outputs.result != ''
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [ -z "$CURSOR_API_KEY" ]; then
            echo "‚ö†Ô∏è CURSOR_API_KEY not set. Skipping AI review."
            exit 0
          fi

          PR_NUMBER="${{ steps.pr.outputs.result }}"
          
          echo "ü§ñ Agent 2: Starting AI review of PR #$PR_NUMBER..."
          
          # Get PR diff using GitHub API
          PR_DIFF=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | \
            jq -r '.diff_url' | xargs curl -s -H "Accept: application/vnd.github.v3.diff")
          
          # Limit diff size to avoid token limits
          PR_DIFF_SUMMARY=$(echo "$PR_DIFF" | head -1000)
          
          PROMPT="Review this PR for safety. Check:
1. Are the changes safe and mechanical (TypeScript/ESLint fixes)?
2. Is there any risk of breaking functionality?
3. Are there any suspicious changes (logic changes, new features)?
4. Should this PR be auto-approved or require human review?

PR #$PR_NUMBER changes:
\`\`\`diff
$PR_DIFF_SUMMARY
\`\`\`

Provide a safety assessment: SAFE_TO_MERGE, NEEDS_REVIEW, or UNSAFE."

          echo "üöÄ Running cursor-agent for PR review..."
          REVIEW_RESULT=$(cursor-agent -p "$PROMPT" --model auto 2>&1 || echo "Review failed")
          
          echo "üìù Review result:"
          echo "$REVIEW_RESULT"
          
          # Save review for next agent
          echo "$REVIEW_RESULT" > ai-review.txt
          
          # Determine review status
          if echo "$REVIEW_RESULT" | grep -qi "SAFE_TO_MERGE"; then
            echo "review_status=SAFE_TO_MERGE" >> $GITHUB_OUTPUT
            echo "‚úÖ AI Review: SAFE_TO_MERGE"
          elif echo "$REVIEW_RESULT" | grep -qi "UNSAFE"; then
            echo "review_status=UNSAFE" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è AI Review: UNSAFE - Requires human review"
          else
            echo "review_status=NEEDS_REVIEW" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è AI Review: NEEDS_REVIEW"
          fi
        continue-on-error: true

      # Agent 3: Post review comment to PR
      - name: Agent 3 - Post Review to PR
        if: steps.changes.outputs.has_changes == 'true' && steps.pr.outputs.result != '' && steps.ai_review.outputs.review_status != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const reviewStatus = '${{ steps.ai_review.outputs.review_status }}';
            const fs = require('fs');
            
            let reviewText = 'Review failed';
            try {
              reviewText = fs.readFileSync('ai-review.txt', 'utf8');
            } catch (e) {
              reviewText = 'Could not read review file';
            }
            
            const emoji = reviewStatus === 'SAFE_TO_MERGE' ? '‚úÖ' : 
                         reviewStatus === 'UNSAFE' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            const comment = `## ${emoji} AI Review (Agent 2)
            
            **Status:** ${reviewStatus}
            
            ${reviewText}
            
            ---
            *Auto-generated by nightly-vercel-build-fix workflow*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            
            console.log(`‚úÖ Posted review comment to PR #${prNumber}`);
            
            // Optional: Auto-approve PR if safe (uncomment to enable)
            // if (reviewStatus === 'SAFE_TO_MERGE') {
            //   await github.rest.pulls.createReview({
            //     owner: context.repo.owner,
            //     repo: context.repo.repo,
            //     pull_number: prNumber,
            //     event: 'APPROVE',
            //     body: 'Auto-approved by AI review agent'
            //   });
            // }
        continue-on-error: true

      # Agent 4: Optional - Auto-fix based on review feedback
      - name: Agent 4 - Address Review Feedback
        if: steps.changes.outputs.has_changes == 'true' && steps.ai_review.outputs.review_status == 'NEEDS_REVIEW'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [ -z "$CURSOR_API_KEY" ]; then
            echo "‚ö†Ô∏è CURSOR_API_KEY not set. Skipping feedback addressing."
            exit 0
          fi
          
          echo "üîÑ Agent 4: Addressing review feedback..."
          
          REVIEW=$(cat ai-review.txt)
          
          PROMPT="The AI review found issues that need addressing:
          
          $REVIEW
          
          Review the current code changes and make minimal fixes to address the concerns.
          Only fix what's necessary - don't over-engineer."
          
          cursor-agent -p "$PROMPT" --model auto || echo "agent4_failed=true" >> $GITHUB_ENV
          
          # If changes were made, commit and push
          if [ -n "$(git status --porcelain)" ]; then
            git config core.hooksPath /dev/null
            git add -A
            git commit -m "fix: address AI review feedback [auto-fix]"
            git push origin "${{ steps.branch.outputs.branch_name }}"
            echo "‚úÖ Pushed additional fixes based on review"
          fi
        continue-on-error: true

      # Summary
      - name: Summary
        run: |
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.vercel_check.outputs.needs_fix }}" = "true" ]; then
            if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
              echo "‚úÖ **Build errors detected and fixed**" >> $GITHUB_STEP_SUMMARY
              echo "- Branch: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- PR: #${{ steps.pr.outputs.result }}" >> $GITHUB_STEP_SUMMARY
              echo "- Deployment: ${{ steps.vercel_check.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è **Build errors detected but no fixes were applied**" >> $GITHUB_STEP_SUMMARY
              echo "- Deployment: ${{ steps.vercel_check.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚úÖ **Vercel build is healthy**" >> $GITHUB_STEP_SUMMARY
            echo "- Deployment: ${{ steps.vercel_check.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          fi

